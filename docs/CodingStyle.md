# Coding Style

## 保持一致

要收敛，不要发散，混乱的系统是没办法维护的。

- 任何地方，新增和修改内容时应该和原风格一致。
- 修改前要先熟悉已有风格，遵守规范。
- 如果有疑问可与原作沟通，不能自作主张。

## 空格

- 多个参数逗号后空格。

    ```java
    System.out.print("%d", 123);
    ```

- 注释标记后空格。

    ```java
    sendMail();// 发送邮件
    ```

- 操作符前后空格。

    ```java
    int a = 5 + 6;
    ```

- 方法调用的括号前后不空格。

    ```java
    int a = Integer.parse("123");
    ```

- 缩进使用空格而不是Tab。
- 语言允许的情况下，用两个空格缩进而不是四个。
- 强制类型转换时，右括号与强制转换值之间不需要任何空格。

## 空行

- 20 行以内的小方法尽量不要加。
- 用空行划分逻辑意味着需要拆分方法，有时候不值得这么做，慎用空行。
- 一般一次只空两行。

## 列数

所有语言每行不得超过 120 列，一下情况可例外：

- Markdown 中不限制，编辑器应设置自动 wrap。
- 注释中引用很长的链接时。

## 引号

有的语言声明字符串同时允许单引号、双引号，此时一般优先使用无引号、单引号，必要时再使用双引号。

## 字符串

进行字符串拼接时首选插值语法而不是用运算符连接，提高可读性。

## 命名

### 原则

- 遵守英语语法，注意单复数、词性、时态，读起来要通顺、自然。
- 遵守编程语言惯例。
- How to Name Things：
    - 保持一致，不要自己发明。
    - 名字尽力明确。
    - 描述要详细，尽管名字可能会很长。
    - 避免缩写，如果必须要，name应该记下来。
    - 避免歧义、模糊不清。
    - 避免魔术值。
    - 对于布尔值，确定的比不确定的好。
    - 正确使用单复数。
    - 正确使用时态。
    - 正确地拼写。
    - 使用动词 + 名词来为函数、方法命名。
    - 使用形容词（可选） + 名词来为类命名。
    - 不要害怕重命名。
    - 多花些时间思考。

### 惯例

- 计数用 count、times，总和用 sum。
- 时间用 xxxAt 的形式，表已经发生的用过去式，比如 publishedAt，表将要发生的用现在时，比如 publishAt。
- 是否用 isXXX、doesXXX、shouldXXX、canXXX 的形式，尤其注意：不是什么单词前面都可以放 is、are 等系词，名词、形容词才可以。

## 排序

在新增代码时，应该遵循下面的原则：

- 找出当前文件或相关代码的排序规律，按这个规律把新代码插到合适的位置。
- 如果原有代码不够多、没有明显规律，按下面的规律排序：
    - 方法排序一般把全部 public 方法排前面，然后是 private 方法。
    - 把相关的放在一起。
    - 按界面顺序排序，例如接收表单的字段排序与界面上展示的顺序保持一致。
    - 按使用顺序排序，先被使用的、使用频率高的排前面，后被使用、使用频率第的排后面。
    - 按自然顺序排序。

## 注释

- 代码的意图尽量通过编码表达，而不是使用注释。
- 代码明确的情况下不要加重复注释。
- 一些合理的注释：
    - 纲要性注释，简要描述一个文件、一个类。
    - 复杂业务逻辑、算法。
    - 代码作用并不直观。
    - 存在多种可选方案，解释选择这种的原因。
    - 因为某些现实导致代码不一致、不优雅或存在副作用时，注明原因及后果。
    - 参考了外部资料，注明链接。
    - 临时标记注释，例如 TODO。
- 注释随代码更新，注释里不要包含不必要的细节。
- 注释掉的代码属于无用代码，除非有额外注释说明，否则应该在提交前删除。

## 日志

- 不要滥用 error 级别日志。
- message 应为固定字符串，不要在里面拼接变量。
- 对于细节、流程日志，要说明影响、逻辑后续的走向。
- 对于错误、异常，尽量说出问题的本质。
- 不要过度打印日志。

## 异常

- 不要吞掉异常，除非错误可忽略，否则不能只 catch 但是不处理。
- 不要过度处理异常，一般使用面向切面的方式。
- 保留原始异常（caused by）。
- 不使用返回值表示成功和失败，避免要求客户端对返回值进行判断。
- 如果要重试，必须加次数限制。

## Java 开发手册摘要

左小括号和右边相邻字符之间不出现空格，右小括号和左边相邻字符之间也不出现空格，左大括号前需要空格。

```java
if (a == b) {

}
```

if/for/while/switch/do 等保留字与括号之间必须加空格。

任何二目、三目运算符左右两边都需要加一个空格。

单行字符超过 120 个后需要换行，原则如下：

- 第二行相对第一行缩进，从第三行开始不再缩进。
- 运算符、方法调用点符号与下文一起换行。
- 方法调用多个参数需要换行时，在逗号后进行。
- 在括号前不要换行。

任何货币金额，以最小货币单位且整数类型来进行存储。

关于基本数据类型和包装数据类型：

- 所有的 POJO 类属性必须使用包装类。
- RPC 方法的返回值和参数必须使用包装数据类型。
- 所有的局部变量使用基本数据类型。

定义 POJO 类时，不要设定任何属性默认值。

不要随意修改 serialVersionUID 字段。

构造方法中禁止加入任何业务逻辑，初始化方法应该放在init方法中。

POJO 类必须写 toString 方法，如果存在继承，则还要在前面添加父类 toString。

使用索引访问 String 的 split 方法得到的数组时，要判断最后一个分隔符后面有没有内容。

类成员与方法访问控制从严：工具类不允许有 public 或 default 构造方法。

日期格式化时，传入 pattern 中表示年份统一用小写 y，YYYY 表示的是 week in which year，意思是当天所在的属于的年份，只要这周跨年，YYYY 返回的就是下一年。

关于 equals 和 hashCode，遵循下面的规则：

- 只要覆写 equals，就必须覆写 hashCode。
- Set 存储的对象必须覆写这两个方法。
- 同理 Map 的键必须重写这两个方法。

在使用 Collectors 类的 toMap 方法转为 Map 集合时，要使用含有参数类型 BinaryOperator 的方法，这是一个函数式接口，继承了 BiFunction 接口，其中的 apply 方法接收两个类型，返回另一个类型。

集合转数组时，必须使用 toArray(T[] array) 方法，传入的是类型一致、长度为 0 的空数组，如果使用无参重载，强转会出现 ClassCastException 异常。

使用 Arrays.asList() 方法将数组转换成集合时，不能修改转换后的数组，会抛出异常。

SimpleDateFormat 线程不安全，一般不要定义为 static，或者加锁，或者使用 DateUtils 工具类。

JDK8 后，使用 Instant 代替 Date，LocalDateTime 代替 Calendar，DateTimeFormatter 代替 SimpleDateFormat。

需要对多个资源进行加锁时，需要保持一致的加锁顺序，避免死锁。

每次访问冲突概率小于 20%，使用乐观锁，乐观锁的重试次数不小于 3 次。

悲观锁：一锁、二判、三更新、四释放。

Random 实例是线程安全的，但是会由于多线程竞争同一 seed 导致性能下降。JDK7 之后可以直接使用 ThreadLocalRandom。

DCL 单例模式中，单例对象应该是 volatile。

switch 括号中变量类型是 String 时，必须先判断 null。

并发环境中，避免使用“等于”判断作为中断或退出条件。

将复杂的逻辑判断结果赋值给一个有意义的布尔变量名。

不要在其他表达式中插入赋值语句。

避免取反逻辑。

方法内部单行注释，在被注释语句上方另起一行。

待办事项 TODO：标记人，标记时间。表示需要实现但还没有实现的功能。

错误 FIXME：标记人，标记时间。表示某段代码是错误的，而且不能工作。

前后端交互 API 需要明确协议、域名、路径、请求方法、请求内容、状态码、响应体。

body 里带参数时必须设置 Content-Type。

如果返回为空，则返回空数组或空集合。

服务端发生错误时，返回的相应信息必须包含 HTTP 状态码，errorCode、errorMessage、用户提示信息四个部分。

前后端交互的 JSON 中，所有的 key 必须为小驼峰。

超大整数场景，一律使用 String 类型返回。

使用 query 参数时，URL 不能超过 2048 字节。

通过 body 传递内容时也要控制长度。

服务器内部重定向必须使用 forward，外部重定向地址必须使用 URL 统一代理模块生成。

对于 trace/debug/info 级别的日志输出，必须进行日志级别开关的判断。

日志打印时禁止使用 JSON 工具将对象转换为 String，直接调用 toString 即可。

单元测试 AIR 原则：

- A：Automatic 自动化。
- I：Independent 独立性。
- R：Repeatable 可重复。

单元测试用例之间决不能互相调用，也不能依赖执行的先后次序。

单元测试 BCDE 原则：

- B：Border 边界值测试。
- C：Correct 正确的输入，并得到预期的结果。
- D：Design 与设计文档相结合来编写单元测试。
- E：Error 强制错误信息输入，并得到预期结果。

属于用户个人的页面或者功能必须进行权限控制校验。

用户敏感数据禁止直接展示，必须对展示数据进行脱敏。

用户传入的任何参数必须做有效性验证。

URL 外部重定向传入的目标地址必须执行白名单过滤。

使用平台资源如短信验证码时，必须实现正确的放重放机制，防止过量浪费资源。

数据库中表达是与否概念的字段，必须使用 is_xxx 命名。

表名、字段名必须使用小写字母或数字，禁止数字开头，禁止两个下划线之间只出现数字。

表名不使用复数名词，禁用保留字。

小数类型为 decimal。

如果存储的字符串长度几乎相等，使用 char。

varchar 长度不要超过 5000，大于此值应当使用 text。

分层领域模型规约：

- DO（Data Object）：此对象与数据库表结构一一对应，通过 DAO 层向上传输数据源对象。
- DTO（Data Transfer Object）：数据传输对象，Service 或 Manager 向外传输的对象。
- BO（Business Object）：业务对象，可以由 Service 层输出的封装业务逻辑的对象。
- Query：数据查询对象，各层接收上层的查询请求。
- VO（View Object）：显示层对象，通常是 Web 向模板渲染引擎层传输的对象。

## HTML

- 外部链接：

    使用 `<a>` 标签引入外部链接时，必须设置 `rel=noopener` 和 `target=_blank` 属性，告知浏览器不让链接窗口引用原始窗口。

    链接要有 title 属性。

- 属性值：

    属性名要小写。

    属性值要小写。

    属性值要用双引号包裹。

    布尔类型属性要省略值。

    属性等号周围不能有空格。

- 注释：

    单行注释前后必须要有空格。

    ```html
    <!-- single line comment -->
    ```

    单行注释要放在标签上面。

- 样式：

    不要通过 `style` 属性设置标签的样式。

    `<style>` 标签的 `type="text/css"` 属性要省略。

- 编码：

    编码设置应该放在文件最前。

    编码必须是 utf-8。

- 表单：

    `input` 标签的 `type` 属性一定要指定。

- 标题：

    标题要按照等级向下有序排列。

- 图像：

    图像 `img` 标签必须要有 `alt` 属性。

    `img` 标签必须设置 `width` 和 `height` 属性。

- JavaScript：

    不要行内绑定事件，例如：

    ```html
    <button onclick="foo()">Button</button>
    ```

    外部引入的 JavaScript 文件要写在 `<body>` 结束标签前。

    `<script>` 标签的 `type` 属性必须要省略。

- link：

    指向外部资源的 `link` 标签的 `href` 属性链接必须指定协议。

- 选择器：

    标签的 id 和 class 必须小写，多个单词通过 `-` 连接。

- 标签：

    可选的闭合标签一定不能省略闭合尾标签。

    标签内容不能为空。

    标签和内容之间避免换行。

    自闭和标签不需要尾部的 `/`符号。

    标签要用小写字母。

- 换行：

    为了可读性可以适当换行，例如标签的属性过多时可以换行。

## CSS

- 格式：

    类名使用破折号代替驼峰，全小写。

    类名最好添加前缀。

    不要使用 ID 选择器。

    如果一个声明中应用了多个选择器，每个选择器独占一行。

    规则声明的左大括号前添加一个空格。

    属性的冒号后加空格，前面不加。

    规则声明的右大括号独占一行。

    规则声明之间用空行分隔开。

    每个声明都要用分号结尾。

- 注释：

    使用行注释。

    注释独占一行。

    给没有自注释的代码写上详细说明。

- 边框：

    定义无边框样式时，用 `border: 0` 代替 `border: none`。

- 颜色：

    使用 三个字符的 16 进制字符表示颜色。

## JavaScript

### 引用

所有的赋值都使用 const，如果一定要对参数重新赋值要使用 let 而不是 var。

### 对象

使用字面值创建对象而不是 new，例如：

```javascript
const obj = {};
```

使用计算属性名创建动态属性名的对象而不是在对象定义外再创建：

```javascript
const obj = {
    [getKey()]: true
}
```

对象方法使用简写形式。

可以简写的属性名要简写，简写的属性要放前面。

属性名不必要加引号就不加。

不要直接调用 `Object.prototype` 上的方法，有的方法可能会被屏蔽，可以这样：

```javascript
Object.prototype.hasOwnProperty.call(obj,key);
```

对象浅拷贝应该使用扩展运算符。

## 数组

用字面量创建数组。

用 push 方法向数组中添加值。

用扩展运算符做浅拷贝。

用扩展运算符将可迭代对象转换成数组，用 `Array.from` 将一个类数组对象转成一个数组。

用 `Array.from` 做 map 遍历，对比扩展运算符可以避免创建一个临时数组。

如果一个数组有很多行，在数组的前后中括号进行换行。

除了 forEach 方法，其他方法如 map、reduce 等方法中要有 return。

### 解构

用对象的解构赋值来获取和使用对象某个或多个属性值。

多个返回值用对象的解构而不是数组解构。

### 字符串

字符串应该使用单引号。

长字符串不应该换行。

当需要动态字符串时，使用模板字符串而不是拼接。

永远不要使用 eval()。

不要使用不必要的转义字符。

### 函数

使用命名函数表达式而不是函数声明，避免函数声明导致的提升。

把立即执行函数包裹在圆括号里。

不要在 if、while 等非函数块内声明函数。

不要使用 arguments 命名参数。

不要使用 arguments 变量，用 rest 替代。

在参数列表中指定默认值而不是在函数里进行判断再赋值。

避免默认参数值的副作用，默认值应当简洁直接。

默认参数赋值放在最后。

创建函数不要使用 Function 构造器。

函数定义部分要有空格。

不要修改传入的参数。

使用扩展运算符调用多参数的函数。

调用或者编写一个包含多个参数的函数，参数列表应该换行，每行只有一个参数和一个结尾的逗号。

不要传入不使用的参数。

### 箭头函数

当一定要使用函数表达式（回调函数）时，使用箭头函数，如果一个函数逻辑复杂，应该把它单独写入一个命名函数里。

如果函数体是一个没有副作用的表达式语句组成，就删除大括号和 return。

如果表达式包含多行就包裹在圆括号里面。

箭头函数的参数用圆括号包裹起来。

避免箭头函数和大于等于、小于等于号混淆。

### 类与构造函数

使用 class 语法，避免操作原型对象。

使用 extends 实现继承。

方法可以返回 this 实现链式调用。

空构造函数或只是代表父类的构造函数是不需要写的。

避免重复定义类成员。

除非外部库或框架需要使用特定的非静态方法，否则类方法应该使用 this 或被写成静态方法。

派生类需要调用 super。

构造器禁止 return。

### 模块

使用 export、import 导出、导入模块。

不要使用 import 通配符。

一个文件中的多个模块在一个 import 语句中引入。

不要导出可变的东西。

如果一个文件只导出一个模块，使用 default。

import 语句要放在所有语句之前。

多行的 import 应该缩进。

### 迭代器与生成器

不要用迭代器而是使用 `for-in`、`for-of`。

不使用生成器。因为无法很好的转为 ES5。

### 属性

访问属性使用点符号，如果是变量获取属性使用方括号。

幂运算使用 `**` 运算符。

### 变量

使用 const 或 let 声明变量。

不要使用链式声明对象。

不要使用一元自增自减运算符。

赋值的时候避免在等号前后换行，如果等号右边太长可以用圆括号包裹起来。

变量如果不使用就不要声明。

### 比较运算符与相等

用严格相等和严格不等进行判断。

if 语句使用 ToBoolean 抽象方法来计算表达式，规则：

- Objects 计算成 true。
- undefined 计算为 false。
- null 计算为 false。
- +0、-0、NaN 计算为 false。
- 空字符串（不包含纯空格字符串）计算为 false。

### 控制语句

当控制语句中的条件太长时要换行，每个条件一行，逻辑运算符放在行首。

### 注释

单行注释放在被注释区域上面，如果注释不是在第一行，那么注释前面就空一行。

### 空格

链式调用过长换行时，点符号开头。

一个代码块后的下一条语句前空一行。

不要用空白行填充块。

圆括号、方括号前后不加空格。计算属性要有空格。

```javascript
[1, 2, 3]
```

花括号内前后加空格。

调用函数时函数名和小括号之间不要空格。

在对象的字面量属性中，键值之间要空格。

### 逗号

不要前置逗号。

使用额外的结尾逗号。

### 分号

语句末尾加分号。

### 类型转换与强制转换

数字转换使用 Number，parseInt 转换应该带着基数。

布尔转换使用两个取反符号：`!!`。

### Get-Set 访问器

不要使用属性的访问器函数，可以自定义。、

如果要使用访问器函数那么 get 和 set 要一起使用。

### 其他

Promise 构造器参数不能是 async。

if 语句等布尔表达式不能是常量。
