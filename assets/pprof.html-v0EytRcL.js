import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as i,d as p,o as n}from"./app-UKhqlS50.js";const l="/assets/top-DfIuBNEN.png",e="/assets/web-j-5IQsWi.png",h="/assets/link-graph-oC7DXhA2.png",t={};function k(c,s){return n(),i("div",null,s[0]||(s[0]=[p(`<h1 id="pprof" tabindex="-1"><a class="header-anchor" href="#pprof"><span>pprof</span></a></h1><h2 id="导出数据" tabindex="-1"><a class="header-anchor" href="#导出数据"><span>导出数据</span></a></h2><h3 id="web-类型应用" tabindex="-1"><a class="header-anchor" href="#web-类型应用"><span>web 类型应用</span></a></h3><p>引入 pprof 包：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">import</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">_</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;net/http/pprof&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这个包中的 init 函数使用 <code>http.HandleFunc</code> 注册了多个路径，所以只要引入并且使用默认 ServerMux 就可以实现数据的收集。如果使用的不是默认 ServerMUX，例如使用了 gin 框架，那么需要手动注册这些路径（gin 框架提供了 <code>gin-contrib/pprof</code>，只要使用其中的 Register 方法注册 gin engine 即可）。</p><p>对于 grpc 服务来说，可以在服务端的其他端口启动一个 http 服务，同时引入 pprof 包间接实现数据的收集。</p><p>访问 http 服务 <code>http://localhost:8080/debug/pprof</code> 即可看到多个指标：</p><ul><li>allocs：过去所有内存分配的样本，包括已经被 GC 的内存也会被统计在内。</li><li>block：导致阻塞同步的堆栈追踪。</li><li>cmdline：当前程序的命令行的完整调用路径。</li><li>goroutine：当前所有运行的 goroutines 堆栈追踪（实时变化）。</li><li>heap：活动对象的内存分配情况，也就是还没被 GC 的部分（实时变化）。</li><li>mutex：导致互斥锁的竞争持有者的堆栈跟踪。</li><li>profile：默认进行 30 秒的 CPU Profiling，得到一个分析用的 profile 文件。</li><li>threadcreate：查看创建新 OS 现成的堆栈跟踪。</li><li>trace：记录程序运行期间发生的各种事件，例如 goroutine 的创建、系统调用、网络请求、垃圾收集、调度等。</li></ul><p>默认情况下不会对 block 和 mutex 进行追踪，需要加上下面的代码：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">runtime</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">SetBlockProfileRate</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">1</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">runtime</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">SetMutexProfileFraction</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">1</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>方法一：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-shell"><span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">go</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">tool</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">pprof</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-seconds=30</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">http://localhost:8080/debug/pprof/heap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>使用此命令会收集 heap 指标的 30 秒内的数据，并将文件下载到本地，然后会进入 pprof 交互式命令行。</p><p>方法二：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-shell"><span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">curl</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-o</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">heap.out</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">http://localhost:8080/debug/pprof/heap?seconds=</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">30</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">go</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">tool</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">pprof</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">heap.out</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>首先使用 curl 获取 30 秒内的 heap 信息存储到文件中，然后分析此文件。</p><h3 id="对于普通程序" tabindex="-1"><a class="header-anchor" href="#对于普通程序"><span>对于普通程序</span></a></h3><p>记录 CPU Profiling</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">file</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">os</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Create</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;cpu.pprof&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">panic</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">defer</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">file</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Close</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">pprof</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">StartCPUProfile</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">file</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">其他逻辑</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">pprof</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">StopCPUProfile</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>记录 heap 等指标：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">file</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">os</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Create</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;cpu.pprof&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">panic</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">defer</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">file</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Close</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">pprof</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Lookup</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;heap&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">).</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">WriteTo</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">file</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="分析数据" tabindex="-1"><a class="header-anchor" href="#分析数据"><span>分析数据</span></a></h2><p>示例程序：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">main</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">runtime</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">SetBlockProfileRate</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">1</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">runtime</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">SetMutexProfileFraction</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">1</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">go</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">for</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">go</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">demo</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">time</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Sleep</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">time</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Millisecond</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">500</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}()</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">http</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">ListenAndServe</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;0.0.0.0:8080&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">var</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">lock</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">sync</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Mutex</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">demo</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">lock</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Lock</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">time</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Sleep</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">time</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Second</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">lock</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Unlock</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="交互式分析" tabindex="-1"><a class="header-anchor" href="#交互式分析"><span>交互式分析</span></a></h3><p>以 CPU Profiling 为例：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-shell"><span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">go</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">tool</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">pprof</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">http://127.0.0.1:8080/debug/pprof/profile</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>然后就会进入 pprof 交互命令行了，可以使用 help 命令查看所有支持的命令。</p><p>查看消耗前 5 的函数：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-shell"><span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">top5</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="`+l+'" alt="top"></p><p>查看图片（需要先安装 graphviz）：</p><p>执行 web 命令即可，这会生成一个 svg 图片并使用默认程序打开。</p><p><img src="'+e+`" alt="web"></p><h3 id="启动-pprof-图片界面" tabindex="-1"><a class="header-anchor" href="#启动-pprof-图片界面"><span>启动 pprof 图片界面</span></a></h3><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-shell"><span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">go</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">tool</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">pprof</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-http=:8082</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">http://127.0.0.1:8080/debug/pprof/allocs</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="理解指标" tabindex="-1"><a class="header-anchor" href="#理解指标"><span>理解指标</span></a></h2><h3 id="flat-flat" tabindex="-1"><a class="header-anchor" href="#flat-flat"><span>flat flat%</span></a></h3><p>一个函数内直接操作的物理耗时。</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">foo</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(){</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">a</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">step1</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">largeArray</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">[</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">math</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">MaxInt64</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">]</span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">int64</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{}</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">step2</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">for</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">i</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">i</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">&lt;</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">math</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">MaxInt64</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">i</span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">++</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">step3</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">step4</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>flat 只会记录 step2 和 step3 的时间；flat% 即是 flat/总运行时间。内存等参数同理。</p><p>所有的 flat 相加即是总采样时间，所有的 flat% 相加应该等于 100%。</p><p>flat 一般是我们最关注的。其代表一个函数可能非常耗时，或者调用了非常多次，或者两者兼而有之，从而导致这个函数消耗了最多的时间。</p><p>如果是我们自己编写的代码，则很可能有一些无脑 for 循环、复杂的计算、字符串操作、频繁申请内存等等。</p><p>如果是第三方库的代码，则很可能我们过于频繁地调用了这些第三方库，或者以不正确的方式使用了这些第三方库。</p><h3 id="cum-cum" tabindex="-1"><a class="header-anchor" href="#cum-cum"><span>cum cum%</span></a></h3><p>相比 flat，cum 则是这个函数内所有操作的物理耗时，比如包括了上述的 step1、2、3、4。</p><p>cum% 即是 cum的时间/总运行时间。内存等参数同理。</p><p>一般 cum 是我们次关注的，且需要结合 flat 来看。flat 可以让我们知道哪个函数耗时多，而cum可以帮助我们找到是哪些函数调用了这些耗时的（flat 值大的）函数。</p><h3 id="sum" tabindex="-1"><a class="header-anchor" href="#sum"><span>sum%</span></a></h3><p>其上所有行的 flat% 的累加。可以视为，这一行及其以上行，其所有的直接操作一共占了多少物理时间。</p><h2 id="连线图" tabindex="-1"><a class="header-anchor" href="#连线图"><span>连线图</span></a></h2><p><img src="`+h+'" alt="连线图"></p><p>自上而下分别是：包名、函数名、flat（flat%）、cum（cum%）。</p><h2 id="火焰图" tabindex="-1"><a class="header-anchor" href="#火焰图"><span>火焰图</span></a></h2><p>火焰图横向长度表示 cum，每一行相比下一行超出的部分代表 flat。</p>',57)]))}const g=a(t,[["render",k]]),o=JSON.parse('{"path":"/go/docs/pprof.html","title":"pprof","lang":"zh-CN","frontmatter":{"description":"pprof 导出数据 web 类型应用 引入 pprof 包： 这个包中的 init 函数使用 http.HandleFunc 注册了多个路径，所以只要引入并且使用默认 ServerMux 就可以实现数据的收集。如果使用的不是默认 ServerMUX，例如使用了 gin 框架，那么需要手动注册这些路径（gin 框架提供了 gin-contrib/ppr...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"pprof\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-06-14T03:10:16.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://ppg007.github.io/go/docs/pprof.html"}],["meta",{"property":"og:site_name","content":"PPG007 的文档"}],["meta",{"property":"og:title","content":"pprof"}],["meta",{"property":"og:description","content":"pprof 导出数据 web 类型应用 引入 pprof 包： 这个包中的 init 函数使用 http.HandleFunc 注册了多个路径，所以只要引入并且使用默认 ServerMux 就可以实现数据的收集。如果使用的不是默认 ServerMUX，例如使用了 gin 框架，那么需要手动注册这些路径（gin 框架提供了 gin-contrib/ppr..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2023-06-14T03:10:16.000Z"}],["meta",{"property":"article:modified_time","content":"2023-06-14T03:10:16.000Z"}]]},"git":{"createdTime":1686712216000,"updatedTime":1686712216000,"contributors":[{"name":"Koston Zhuang","username":"","email":"koston.zhuang@maiscrm.com","commits":1}]},"readingTime":{"minutes":3.77,"words":1130},"filePathRelative":"go/docs/pprof.md","excerpt":"\\n<h2>导出数据</h2>\\n<h3>web 类型应用</h3>","autoDesc":true}');export{g as comp,o as data};
