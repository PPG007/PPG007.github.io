import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,d as p,o as e}from"./app-rQI8KFp-.js";const i={};function l(c,s){return e(),n("div",null,s[0]||(s[0]=[p(`<h1 id="缓存" tabindex="-1"><a class="header-anchor" href="#缓存"><span>缓存</span></a></h1><h2 id="缓存简介" tabindex="-1"><a class="header-anchor" href="#缓存简介"><span>缓存简介</span></a></h2><p>什么是缓存：</p><ul><li>存在内存中的临时数据。</li><li>将用户经常查询的数据放在缓存中，从缓存中查询，提高查询效率，解决了高并发系统的性能问题。</li></ul><p>为什么用缓存：</p><ul><li>减少访问数据库的次数，减小系统开销，提高系统效率。</li></ul><p>什么样的数据适合用缓存：</p><ul><li>经常查询且不经常改变的数据。</li></ul><h2 id="mybatis-缓存" tabindex="-1"><a class="header-anchor" href="#mybatis-缓存"><span>Mybatis 缓存</span></a></h2><div class="hint-container tip"><p class="hint-container-title">提示</p><p>MyBatis 内置了一个强大的事务性查询缓存机制，它可以非常方便地配置和定制。</p></div><p>默认情况下，只启用了本地的会话缓存，它仅仅对一个会话中的数据进行缓存。(一级缓存，sqlsession 级别的缓存)。</p><p>二级缓存需要手动开启，基于 namespace 级别。</p><p>mybatis 提供了 cache 接口可以自定义缓存(二级)。</p><h2 id="mybatis-缓存机制" tabindex="-1"><a class="header-anchor" href="#mybatis-缓存机制"><span>Mybatis 缓存机制</span></a></h2><ul><li>映射语句文件中的所有 select 语句的结果将会被缓存。</li><li>映射语句文件中的所有 insert、update 和 delete 语句会刷新缓存。</li><li>缓存会使用最近最少使用算法（LRU, Least Recently Used）算法来清除不需要的缓存。</li><li>缓存不会定时进行刷新（也就是说，没有刷新间隔）。</li><li>缓存会保存列表或对象（无论查询方法返回哪种）的 1024 个引用。</li><li>缓存会被视为读/写缓存，这意味着获取到的对象并不是共享的，可以安全地被调用者修改，而不干扰其他调用者或线程所做的潜在修改。</li></ul><h2 id="一级缓存" tabindex="-1"><a class="header-anchor" href="#一级缓存"><span>一级缓存</span></a></h2><p>实体类代码：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-java"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">@</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Data</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">@</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">EqualsAndHashCode</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">public</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">class</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">User</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">private</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">int</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">id</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">private</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">String</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">username</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">private</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">String</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">password</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mapper.xml：</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-xml"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">update</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">id</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;updateUser&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">update</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">mydata.usertable</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">set</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">password=#{password}</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">where</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">id=#{id}</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;/</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">update</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">select</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">id</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;queryUsers&quot;</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">resultType</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;pojo.User&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">select</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">*</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">from</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">mydata.usertable</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;/</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">select</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">select</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">id</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;queryUserById&quot;</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">resultType</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;pojo.User&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">select</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">*</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">from</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">mydata.usertable</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">where</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">id=#{id}</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;/</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">select</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>测试一，两次查询同一记录(sqlsession 生命周期内):</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-text"><span class="line"><span>Logging</span><span class="space"> </span><span>initialized</span><span class="space"> </span><span>using</span><span class="space"> </span><span>&#39;class</span><span class="space"> </span><span>org.apache.ibatis.logging.stdout.StdOutImpl&#39;</span><span class="space"> </span><span>adapter.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>Opening</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span></span>
<span class="line"><span>Created</span><span class="space"> </span><span>connection</span><span class="space"> </span><span>293508253.</span></span>
<span class="line"><span>Setting</span><span class="space"> </span><span>autocommit</span><span class="space"> </span><span>to</span><span class="space"> </span><span>false</span><span class="space"> </span><span>on</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span class="space"> </span><span>Preparing:</span><span class="space"> </span><span>select</span><span class="space"> </span><span>*</span><span class="space"> </span><span>from</span><span class="space"> </span><span>mydata.usertable</span><span class="space"> </span><span>where</span><span class="space"> </span><span>id=?</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span>Parameters:</span><span class="space"> </span><span>1(Integer)</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Columns:</span><span class="space"> </span><span>id,</span><span class="space"> </span><span>username,</span><span class="space"> </span><span>password</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Row:</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>丛维仪,</span><span class="space"> </span><span>110</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Total:</span><span class="space"> </span><span>1</span></span>
<span class="line"><span>User(id=1,</span><span class="space"> </span><span>username=丛维仪,</span><span class="space"> </span><span>password=110)</span></span>
<span class="line"><span>==============================</span></span>
<span class="line"><span>User(id=1,</span><span class="space"> </span><span>username=丛维仪,</span><span class="space"> </span><span>password=110)</span></span>
<span class="line"><span>true</span></span>
<span class="line"><span>Resetting</span><span class="space"> </span><span>autocommit</span><span class="space"> </span><span>to</span><span class="space"> </span><span>true</span><span class="space"> </span><span>on</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>Closing</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>Returned</span><span class="space"> </span><span>connection</span><span class="space"> </span><span>293508253</span><span class="space"> </span><span>to</span><span class="space"> </span><span>pool.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>由日志文件可以看出，两次查询同一记录只访问了一次数据库。</p></div></li><li><p>测试二，两次查询的不是同一记录：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-text"><span class="line"><span>Logging</span><span class="space"> </span><span>initialized</span><span class="space"> </span><span>using</span><span class="space"> </span><span>&#39;class</span><span class="space"> </span><span>org.apache.ibatis.logging.stdout.StdOutImpl&#39;</span><span class="space"> </span><span>adapter.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>Opening</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span></span>
<span class="line"><span>Created</span><span class="space"> </span><span>connection</span><span class="space"> </span><span>293508253.</span></span>
<span class="line"><span>Setting</span><span class="space"> </span><span>autocommit</span><span class="space"> </span><span>to</span><span class="space"> </span><span>false</span><span class="space"> </span><span>on</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span class="space"> </span><span>Preparing:</span><span class="space"> </span><span>select</span><span class="space"> </span><span>*</span><span class="space"> </span><span>from</span><span class="space"> </span><span>mydata.usertable</span><span class="space"> </span><span>where</span><span class="space"> </span><span>id=?</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span>Parameters:</span><span class="space"> </span><span>1(Integer)</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Columns:</span><span class="space"> </span><span>id,</span><span class="space"> </span><span>username,</span><span class="space"> </span><span>password</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Row:</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>丛维仪,</span><span class="space"> </span><span>110</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Total:</span><span class="space"> </span><span>1</span></span>
<span class="line"><span>User(id=1,</span><span class="space"> </span><span>username=丛维仪,</span><span class="space"> </span><span>password=110)</span></span>
<span class="line"><span>==============================</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span class="space"> </span><span>Preparing:</span><span class="space"> </span><span>select</span><span class="space"> </span><span>*</span><span class="space"> </span><span>from</span><span class="space"> </span><span>mydata.usertable</span><span class="space"> </span><span>where</span><span class="space"> </span><span>id=?</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span>Parameters:</span><span class="space"> </span><span>2(Integer)</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Columns:</span><span class="space"> </span><span>id,</span><span class="space"> </span><span>username,</span><span class="space"> </span><span>password</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Row:</span><span class="space"> </span><span>2,</span><span class="space"> </span><span>王海洋,</span><span class="space"> </span><span>13573285937</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Total:</span><span class="space"> </span><span>1</span></span>
<span class="line"><span>User(id=2,</span><span class="space"> </span><span>username=王海洋,</span><span class="space"> </span><span>password=13573285937)</span></span>
<span class="line"><span>false</span></span>
<span class="line"><span>Resetting</span><span class="space"> </span><span>autocommit</span><span class="space"> </span><span>to</span><span class="space"> </span><span>true</span><span class="space"> </span><span>on</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>Closing</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>Returned</span><span class="space"> </span><span>connection</span><span class="space"> </span><span>293508253</span><span class="space"> </span><span>to</span><span class="space"> </span><span>pool.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>由日志文件可以看出，两次查询不同记录访问了两次数据库。</p></div></li><li><p>测试三，查询完第一条记录后，更新数据库内任意记录，再次查询同一条记录：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-text"><span class="line"><span>Logging</span><span class="space"> </span><span>initialized</span><span class="space"> </span><span>using</span><span class="space"> </span><span>&#39;class</span><span class="space"> </span><span>org.apache.ibatis.logging.stdout.StdOutImpl&#39;</span><span class="space"> </span><span>adapter.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>PooledDataSource</span><span class="space"> </span><span>forcefully</span><span class="space"> </span><span>closed/removed</span><span class="space"> </span><span>all</span><span class="space"> </span><span>connections.</span></span>
<span class="line"><span>Opening</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span></span>
<span class="line"><span>Created</span><span class="space"> </span><span>connection</span><span class="space"> </span><span>293508253.</span></span>
<span class="line"><span>Setting</span><span class="space"> </span><span>autocommit</span><span class="space"> </span><span>to</span><span class="space"> </span><span>false</span><span class="space"> </span><span>on</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span class="space"> </span><span>Preparing:</span><span class="space"> </span><span>select</span><span class="space"> </span><span>*</span><span class="space"> </span><span>from</span><span class="space"> </span><span>mydata.usertable</span><span class="space"> </span><span>where</span><span class="space"> </span><span>id=?</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span>Parameters:</span><span class="space"> </span><span>1(Integer)</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Columns:</span><span class="space"> </span><span>id,</span><span class="space"> </span><span>username,</span><span class="space"> </span><span>password</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Row:</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>丛维仪,</span><span class="space"> </span><span>110</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Total:</span><span class="space"> </span><span>1</span></span>
<span class="line"><span>User(id=1,</span><span class="space"> </span><span>username=丛维仪,</span><span class="space"> </span><span>password=110)</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span class="space"> </span><span>Preparing:</span><span class="space"> </span><span>update</span><span class="space"> </span><span>mydata.usertable</span><span class="space"> </span><span>set</span><span class="space"> </span><span>password=?</span><span class="space"> </span><span>where</span><span class="space"> </span><span>id=?</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span>Parameters:</span><span class="space"> </span><span>test1(String),</span><span class="space"> </span><span>2(Integer)</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Updates:</span><span class="space"> </span><span>1</span></span>
<span class="line"><span>==============================</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span class="space"> </span><span>Preparing:</span><span class="space"> </span><span>select</span><span class="space"> </span><span>*</span><span class="space"> </span><span>from</span><span class="space"> </span><span>mydata.usertable</span><span class="space"> </span><span>where</span><span class="space"> </span><span>id=?</span></span>
<span class="line"><span>==&gt;</span><span class="space"> </span><span>Parameters:</span><span class="space"> </span><span>1(Integer)</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Columns:</span><span class="space"> </span><span>id,</span><span class="space"> </span><span>username,</span><span class="space"> </span><span>password</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Row:</span><span class="space"> </span><span>1,</span><span class="space"> </span><span>丛维仪,</span><span class="space"> </span><span>110</span></span>
<span class="line"><span>&lt;==</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>Total:</span><span class="space"> </span><span>1</span></span>
<span class="line"><span>User(id=1,</span><span class="space"> </span><span>username=丛维仪,</span><span class="space"> </span><span>password=110)</span></span>
<span class="line"><span>true</span></span>
<span class="line"><span>Rolling</span><span class="space"> </span><span>back</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>Resetting</span><span class="space"> </span><span>autocommit</span><span class="space"> </span><span>to</span><span class="space"> </span><span>true</span><span class="space"> </span><span>on</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>Closing</span><span class="space"> </span><span>JDBC</span><span class="space"> </span><span>Connection</span><span class="space"> </span><span>[com.mysql.cj.jdbc.ConnectionImpl@117e949d]</span></span>
<span class="line"><span>Returned</span><span class="space"> </span><span>connection</span><span class="space"> </span><span>293508253</span><span class="space"> </span><span>to</span><span class="space"> </span><span>pool.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>由日志文件可以看出，更新数据库内容导致了缓存的更新。</p></div></li></ul><h3 id="缓存失效的情况" tabindex="-1"><a class="header-anchor" href="#缓存失效的情况"><span>缓存失效的情况</span></a></h3><ol><li>查询不同的记录。</li><li>增删改操作后，必定刷新缓存。</li><li>查询不同的 mapper.xml。</li><li>手动清理缓存。</li></ol><p>手动清理缓存方法：</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-java"><span class="line"><span style="--shiki-dark:#E5C07B;--shiki-light:#001080;">sqlSession</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">clearCache</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="二级缓存" tabindex="-1"><a class="header-anchor" href="#二级缓存"><span>二级缓存</span></a></h2><h3 id="开启二级缓存" tabindex="-1"><a class="header-anchor" href="#开启二级缓存"><span>开启二级缓存</span></a></h3><p>在映射器 xml 中添加：</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-xml"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">cache</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">/&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>缓存只作用于 cache 标签所在的<strong>映射文件</strong>中的语句。如果你混合使用 Java API 和 XML 映射文件，在共用接口中的语句将不会被默认缓存。你需要使用 <code>@CacheNamespaceRef</code> 注解指定缓存作用域。</p></div><h3 id="cache-元素的属性" tabindex="-1"><a class="header-anchor" href="#cache-元素的属性"><span>cache 元素的属性</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-xml"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">cache</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">eviction</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;FIFO&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">flushInterval</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;60000&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">size</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;512&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">readOnly</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;true&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">/&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>eviction：指定清除策略，默认的清除策略是 <strong>LRU</strong>。</p><p>可用的清除策略有：</p><ul><li>LRU：最近最少使用：移除最长时间不被使用的对象。</li><li>FIFO：先进先出：按对象进入缓存的顺序来移除它们。</li><li>SOFT：软引用：基于垃圾回收器状态和软引用规则移除对象。</li><li>WEAK：弱引用：更积极地基于垃圾收集器状态和弱引用规则移除对象。</li></ul></li><li><p>flushInterval：可以被设置为任意的正整数，设置的值应该是一个以毫秒为单位的合理时间量。 默认情况是不设置，也就是没有刷新间隔，缓存仅仅会在调用语句时刷新。</p></li><li><p>size：（引用数目）可以被设置为任意正整数，要注意欲缓存对象的大小和运行环境中可用的内存资源。默认值是 1024。</p></li><li><p>readOnly：（只读）可以被设置为 true 或 false。只读的缓存会给所有调用者返回缓存对象的相同实例。 因此这些对象不能被修改。这就提供了可观的性能提升。而可读写的缓存会（通过序列化）返回缓存对象的拷贝。 速度上会慢一些，但是更安全，因此默认值是 false。</p></li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>二级缓存是事务性的。这意味着，当 SqlSession 完成并提交时，或是完成并回滚，但没有执行 flushCache=true 的 insert/delete/update 语句时，缓存会获得更新。</p></div><h3 id="使用二级缓存的步骤" tabindex="-1"><a class="header-anchor" href="#使用二级缓存的步骤"><span>使用二级缓存的步骤</span></a></h3><p>开启全局缓存：</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-xml"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">settings</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">setting</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;cacheEnabled&quot;</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">value</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;true&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">/&gt;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;/</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">settings</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在要开启二级缓存的 mapper.xml 中开启二级缓存：</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-xml"><span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">&lt;</span><span style="--shiki-dark:#E06C75;--shiki-light:#800000;">cache</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">eviction</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;FIFO&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">flushInterval</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;30000&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">size</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;512&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#E50000;">readOnly</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#0000FF;">&quot;false&quot;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#800000;">/&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>若 readOnly 属性设置为 false，可能会抛出实体类的序列化异常。</p></div><p>测试：</p><ul><li>只有当会话提交或者关闭时，才会提交到二级缓存。</li><li>所有的数据都会先放在以及惠存。</li></ul><p>异常分析：</p><p>为什么要实现序列化：</p><ul><li>缓存机制：将查询结果保存到内存中。</li><li>内存饱满，需要移出时，MyBatis 就会自动将内存中的内容进行移除，但是文件很重要，不能，此时就需要进行序列化，以文件的形式将内容从内存保存到硬盘上，一个内容保存成文件的读写，必须实现序列化。</li></ul><p>解决方法：</p><ul><li>实体类实现 Serializable 序列化接口。</li><li>将 cache 元素的 readOnly 属性设置为 true。</li></ul><h3 id="二级缓存工作机制" tabindex="-1"><a class="header-anchor" href="#二级缓存工作机制"><span>二级缓存工作机制</span></a></h3><ul><li>一个会话查询一条记录，这个记录就会被放在当前会话的<strong>一级缓存</strong>中。</li><li>如果当前会话关闭了，一级缓存会消失，一级缓存中的数据被保存到二级缓存中。</li><li>新的会话查询信息，就可以从二级缓存中获取内容。</li><li>不同的 mapper 查出的数据会放在自己对应的缓存(map)中。</li></ul><h2 id="自定义缓存" tabindex="-1"><a class="header-anchor" href="#自定义缓存"><span>自定义缓存</span></a></h2><p>除了上述缓存的方式，也可以通过实现你己的缓存，或为其他第三方缓存方案创建适配器，来完全覆盖缓存行为。</p><p>Ehcache 是一种广泛使用的开源 Java 分布式缓存。</p>`,52)]))}const r=a(i,[["render",l]]),h=JSON.parse('{"path":"/mybatis/docs/cache.html","title":"缓存","lang":"zh-CN","frontmatter":{"description":"缓存 缓存简介 什么是缓存： 存在内存中的临时数据。 将用户经常查询的数据放在缓存中，从缓存中查询，提高查询效率，解决了高并发系统的性能问题。 为什么用缓存： 减少访问数据库的次数，减小系统开销，提高系统效率。 什么样的数据适合用缓存： 经常查询且不经常改变的数据。 Mybatis 缓存 提示 MyBatis 内置了一个强大的事务性查询缓存机制，它可以...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"缓存\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-05-13T01:18:18.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://ppg007.github.io/mybatis/docs/cache.html"}],["meta",{"property":"og:site_name","content":"PPG007 的文档"}],["meta",{"property":"og:title","content":"缓存"}],["meta",{"property":"og:description","content":"缓存 缓存简介 什么是缓存： 存在内存中的临时数据。 将用户经常查询的数据放在缓存中，从缓存中查询，提高查询效率，解决了高并发系统的性能问题。 为什么用缓存： 减少访问数据库的次数，减小系统开销，提高系统效率。 什么样的数据适合用缓存： 经常查询且不经常改变的数据。 Mybatis 缓存 提示 MyBatis 内置了一个强大的事务性查询缓存机制，它可以..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-13T01:18:18.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-13T01:18:18.000Z"}]]},"git":{"createdTime":1640699484000,"updatedTime":1747099098000,"contributors":[{"name":"PPG007","username":"PPG007","email":"1658272229@com请求","commits":1,"url":"https://github.com/PPG007"},{"name":"Koston Zhuang","username":"","email":"koston.zhuang@maiscrm.com","commits":1}]},"readingTime":{"minutes":6.37,"words":1911},"filePathRelative":"mybatis/docs/cache.md","excerpt":"\\n<h2>缓存简介</h2>\\n<p>什么是缓存：</p>\\n<ul>\\n<li>存在内存中的临时数据。</li>\\n<li>将用户经常查询的数据放在缓存中，从缓存中查询，提高查询效率，解决了高并发系统的性能问题。</li>\\n</ul>","autoDesc":true}');export{r as comp,h as data};
