import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as i,d as n,o as p}from"./app-rQI8KFp-.js";const l={};function h(e,s){return p(),i("div",null,s[0]||(s[0]=[n(`<h1 id="load-balance" tabindex="-1"><a class="header-anchor" href="#load-balance"><span>Load Balance</span></a></h1><h2 id="nginx" tabindex="-1"><a class="header-anchor" href="#nginx"><span>Nginx</span></a></h2><p><a href="https://www.nginx.com/blog/nginx-1-13-10-grpc/" target="_blank" rel="noopener noreferrer">Reference</a></p><h3 id="no-tls" tabindex="-1"><a class="header-anchor" href="#no-tls"><span>NO TLS</span></a></h3><p>修改 Nginx 配置文件：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">worker_processes</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">auto;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">error_log</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/var/log/nginx/error.log;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">events</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">worker_connections</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">768</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">http</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">access_log</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/var/log/nginx/access.log;</span></span>
<span class="line"></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">upstream</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">hello_services</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">server</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">0.0.0.0:8081;</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">server</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">0.0.0.0:8082;</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">server</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">listen</span><span class="tab">	</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">80</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">http2;</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">location</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">grpc_pass</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">grpc://hello_services;</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 gRPC 服务端启动在对应的端口即可，访问 Nginx 监听的 80 端口即可访问 gRPC 的接口。</p><h3 id="tls" tabindex="-1"><a class="header-anchor" href="#tls"><span>TLS</span></a></h3><p>首先执行下面的命令，输入信息后生成自签名证书：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-shell"><span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">#!/usr/bin/zsh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">#</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">首先生成私钥</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">openssl</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">genrsa</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-out</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">cakey.pem</span></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">#</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">创建请求文件</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">openssl</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">req</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-new</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-key</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">cakey.pem</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-out</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">rootCA.csr</span></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">#</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">自签署</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">openssl</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">x509</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-req</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-in</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">rootCA.csr</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-signkey</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">cakey.pem</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-out</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">x509.crt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">#</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">首先生成私钥</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">openssl</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">genrsa</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-out</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">prikey.pem</span></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">#</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">创建请求文件</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">openssl</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">req</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-new</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-key</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">prikey.pem</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-out</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">local.csr</span></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">#</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">签署证书请求</span></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">openssl</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">x509</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-req</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-in</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">local.csr</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-CA</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">x509.crt</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-CAkey</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">cakey.pem</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-out</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">localhost.crt</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">-CAcreateserial</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 Nginx 的配置文件：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">worker_processes</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">auto;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">error_log</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/var/log/nginx/error.log;</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">events</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">worker_connections</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">768</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">http</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">access_log</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/var/log/nginx/access.log;</span></span>
<span class="line"></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">upstream</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">hello_services</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">server</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">0.0.0.0:8081;</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">server</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">0.0.0.0:8082;</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">server</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">server_name</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">localhost;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">ssl_certificate</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/home/user/playground/grpc-resolver/cert/localhost.crt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">ssl_certificate_key</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/home/user/playground/grpc-resolver/cert/prikey.pem;</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">ssl_protocols</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">TLSv1.2</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">TLSv1.3;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">ssl_ciphers</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">ssl_prefer_server_ciphers</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">on</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">;</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">listen</span><span class="tab">	</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">90</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">ssl</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">http2;</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">location</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">/</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">grpc_pass</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">grpc://hello_services;</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TLS 加解密的过程交给 Nginx 来完成，服务端和客户端使用 insecure 方式连接即可。</p><h2 id="注册中心" tabindex="-1"><a class="header-anchor" href="#注册中心"><span>注册中心</span></a></h2><p><a href="https://github.com/PPG007/grpc-resolver" target="_blank" rel="noopener noreferrer">Example Code</a></p><p>grpc 中，<a href="https://github.com/grpc/grpc/blob/master/doc/naming.md" target="_blank" rel="noopener noreferrer">NameResolver</a> 被用来解析请求的地址，决定将请求发送给那个实例，默认情况下使用 DNS 完成，但是此种情况下，如果不使用 Nginx、Istio 等原生支持 grpc 流量负载均衡的中间件，对于持久连接（即 grpc.Dial 后创建 client 都用这一个 connect）来说，DNS 解析后就确定了后续请求发送给那个实例，因此后续的请求在重置连接前会进入同一个示例，例如 Kubernetes 中使用 Service 部署服务，服务间用 grpc 互相调用是不会负载均衡的，在这种情况下，可以结合注册中心以及自定义 NameResolver 实现负载均衡。</p><p>grpc-go 中提供了 Resolver 和 Builder 两个接口，只要实现这两个接口就可以自定义 NameResolver。</p><p>为了实现服务端注册到注册中心，定义一个 ServerManager 接口：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">type</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">ServerManager</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">interface</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">RegisterToCenter</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">serviceName</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">error</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">获取自己的</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">IPv4</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">地址</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">GetSelfIPv4Addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">([]</span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">error</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">[]</span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">net</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">InterfaceAddrs</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">for</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">_</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">address</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">range</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">host</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">strings</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Split</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">address</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">String</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(),</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;/&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)[</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">]</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">i</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">net</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">ParseIP</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">host</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">).</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">To4</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">i</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">&amp;&amp;</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">i</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">IsLoopback</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">append</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">i</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">String</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">())</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="consul" tabindex="-1"><a class="header-anchor" href="#consul"><span>Consul</span></a></h3><p>实现向服务端注册：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">const</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E5C07B;--shiki-light:#0070C1;">consulHost</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;127.0.0.1&quot;</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E5C07B;--shiki-light:#0070C1;">consulPort</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">8500</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">type</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulConfig</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">struct</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serverHost</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serverPort</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">int</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">servicePort</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">int</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Client</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">healthCheckEndpoint</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">healthCheckEndpoint</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">是一个</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">http</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">地址，用于进行服务健康检查</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewConsulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">healthCheckEndpoint</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">servicePort</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">int</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">error</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">config</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">DefaultConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serverHost</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">consulHost</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serverPort</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">consulPort</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">servicePort</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">servicePort</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">healthCheckEndpoint</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">healthCheckEndpoint</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">config</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Address</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">fmt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Sprintf</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;</span><span style="--shiki-dark:#D19A66;--shiki-light:#001080;">%s</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">:</span><span style="--shiki-dark:#D19A66;--shiki-light:#001080;">%d</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serverHost</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serverPort</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewClient</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">config</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">result</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">c</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">RegisterToCenter</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">serviceName</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">error</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">manager</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">GetSelfIPv4Addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">registration</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">AgentServiceRegistration</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serviceName</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">ID</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">fmt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Sprintf</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;</span><span style="--shiki-dark:#D19A66;--shiki-light:#001080;">%s</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">_</span><span style="--shiki-dark:#D19A66;--shiki-light:#001080;">%s</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serviceName</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">primitive</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewObjectID</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">().</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Hex</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()),</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Port</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">servicePort</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Address</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">[</span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">],</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Check</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">AgentServiceCheck</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">HTTP</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">healthCheckEndpoint</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Interval</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;10s&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">DeregisterCriticalServiceAfter</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;20s&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">},</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Agent</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">().</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">ServiceRegister</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">registration</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">c</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">GetClient</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Client</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现 Resolver：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">type</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolver</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">struct</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">cc</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">ClientConn</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serviceName</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Client</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">lastIndex</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">uint64</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">c</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">ResolveNow</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">opt</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">ResolveNowOptions</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">services</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">_</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Health</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">().</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Service</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serviceName</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">true</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">QueryOptions</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{})</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">UpdateAddresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">services</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Close</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">log</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Println</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;ConsulResolver</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">will</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">be</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">closed&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">由于</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">Consul</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">不支持长连接，因此使用长轮询的方式实现同步服务器上下线，这就需要维护一个</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">lastIndex</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">c</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Watch</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">lastIndex</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">0</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">for</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">services</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">meta</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Health</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">().</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Service</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serviceName</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">true</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">QueryOptions</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">WaitIndex</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">lastIndex</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">})</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">lastIndex</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">meta</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">LastIndex</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">UpdateAddresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">services</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">c</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">UpdateAddresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">services</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">[]</span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">ServiceEntry</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">[]</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Address</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">for</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">_</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">service</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">range</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">services</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">append</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Address</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Addr</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">fmt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Sprintf</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;</span><span style="--shiki-dark:#D19A66;--shiki-light:#001080;">%s</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">:</span><span style="--shiki-dark:#D19A66;--shiki-light:#001080;">%d</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">service</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Service</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Address</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">service</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Service</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Port</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">),</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">})</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">调用此方法可以在服务上下线之后更新客户端可用的</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">address</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">列表</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">cc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">UpdateState</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">State</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">addresses</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">})</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后实现 Builder 接口：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">package</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulresolver</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">import</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;nameresolver/server/consul&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;github.com/hashicorp/consul/api&quot;</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;google.golang.org/grpc/resolver&quot;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">const</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E5C07B;--shiki-light:#0070C1;">CONSUL_RESOLVER_SCHEMA</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;consul&quot;</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Init</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">consulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">consul</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewConsulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#098658;">0</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">panic</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Error</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">())</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">consulResolverBuilder</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewConsulResolverBuilder</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">consulConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">GetClient</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">())</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Register</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">consulResolverBuilder</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">type</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolverBuilder</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">struct</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Client</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewConsulResolverBuilder</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">client</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">api</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolverBuilder</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolverBuilder</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">c</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolverBuilder</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Build</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">target</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Target</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">cc</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">ClientConn</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#001080;--shiki-light-font-style:inherit;">opts</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">BuildOptions</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">error</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">service</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">target</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">URL</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">Host</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">r</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">cc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">cc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">c</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">client</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">serviceName</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">service</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">构建</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">resolver</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">的时候先更新一次</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">address</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">r</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">ResolveNow</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">resolver</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">ResolveNowOptions</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{})</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">开启协程监听</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">go</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">r</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Watch</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">r</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">返回当前能够处理的</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">schema，schema</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">指的就是在建立</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">grpc</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">连接的时候传入的服务端地址的协议部分</span></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">//</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">例如这个</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">Resolver</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">可以解析形如</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">consul://HelloService</span><span class="space"> </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#008000;--shiki-light-font-style:inherit;">这样的地址</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#0000FF;">func</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">*</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">consulResolverBuilder</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span><span class="space"> </span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Scheme</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">()</span><span class="space"> </span><span style="--shiki-dark:#C678DD;--shiki-light:#267F99;">string</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">return</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">CONSUL_RESOLVER_SCHEMA</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>grpc-go 中默认的负载均衡策略是 pick-first，即选择第一个，还支持轮询方式，需要进行配置才能实现负载均衡：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Dial</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">target</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">WithDefaultServiceConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">\`{&quot;loadBalancingPolicy&quot;:&quot;round_robin&quot;}\`</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">),</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件参考：<a href="https://github.com/grpc/grpc/blob/master/doc/service_config.md" target="_blank" rel="noopener noreferrer">ServiceConfig</a></p><h3 id="tls-1" tabindex="-1"><a class="header-anchor" href="#tls-1"><span>TLS</span></a></h3><p>使用 Nginx 部分中的命令生成自签证书，然后修改服务端启动方法：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">crt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">credentials</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewServerTLSFromFile</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;localhost.crt&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">&quot;prikey.pem&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#AF00DB;">if</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#56B6C2;--shiki-light:#000000;">!=</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">nil</span><span class="space"> </span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">panic</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Error</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">())</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">}</span></span>
<span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpcServer</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">:=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewServer</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Creds</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">crt</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">),</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并修改服务端启动方法：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-dark:#abb2bf;--shiki-light:#000000;--shiki-dark-bg:#282c34;--shiki-light-bg:#FFFFFF;"><pre class="shiki shiki-themes one-dark-pro light-plus vp-code"><code class="language-go"><span class="line"><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">cc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">err</span><span class="space"> </span><span style="--shiki-dark:#E5C07B;--shiki-light:#000000;">=</span><span class="space"> </span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">Dial</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">target</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">WithTransportCredentials</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">credentials</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">NewTLS</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#C678DD;--shiki-light:#000000;">&amp;</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">tls</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#E5C07B;--shiki-light:#267F99;">Config</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">{</span></span>
<span class="line"><span class="tab">	</span><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">InsecureSkipVerify</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">:</span><span class="space"> </span><span style="--shiki-dark:#D19A66;--shiki-light:#0000FF;">true</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">,</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">})),</span></span>
<span class="line"><span class="tab">	</span><span style="--shiki-dark:#E06C75;--shiki-light:#001080;">grpc</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#795E26;">WithDefaultServiceConfig</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">(</span><span style="--shiki-dark:#98C379;--shiki-light:#A31515;">\`{&quot;loadBalancingPolicy&quot;:&quot;round_robin&quot;}\`</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">),</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#000000;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,34)]))}const c=a(l,[["render",h]]),r=JSON.parse('{"path":"/grpc-and-protobuf/docs/grpc/loadBalance.html","title":"Load Balance","lang":"zh-CN","frontmatter":{"description":"Load Balance Nginx Reference NO TLS 修改 Nginx 配置文件： 将 gRPC 服务端启动在对应的端口即可，访问 Nginx 监听的 80 端口即可访问 gRPC 的接口。 TLS 首先执行下面的命令，输入信息后生成自签名证书： 修改 Nginx 的配置文件： TLS 加解密的过程交给 Nginx 来完成，服务端和客...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Load Balance\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2022-07-28T02:40:52.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://ppg007.github.io/grpc-and-protobuf/docs/grpc/loadBalance.html"}],["meta",{"property":"og:site_name","content":"PPG007 的文档"}],["meta",{"property":"og:title","content":"Load Balance"}],["meta",{"property":"og:description","content":"Load Balance Nginx Reference NO TLS 修改 Nginx 配置文件： 将 gRPC 服务端启动在对应的端口即可，访问 Nginx 监听的 80 端口即可访问 gRPC 的接口。 TLS 首先执行下面的命令，输入信息后生成自签名证书： 修改 Nginx 的配置文件： TLS 加解密的过程交给 Nginx 来完成，服务端和客..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2022-07-28T02:40:52.000Z"}],["meta",{"property":"article:modified_time","content":"2022-07-28T02:40:52.000Z"}]]},"git":{"createdTime":1651811490000,"updatedTime":1658976052000,"contributors":[{"name":"PPG007","username":"PPG007","email":"1658272229@qq.com","commits":1,"url":"https://github.com/PPG007"},{"name":"Koston Zhuang","username":"","email":"koston.zhuang@maiscrm.com","commits":1}]},"readingTime":{"minutes":3.83,"words":1149},"filePathRelative":"grpc-and-protobuf/docs/grpc/loadBalance.md","excerpt":"\\n<h2>Nginx</h2>\\n<p><a href=\\"https://www.nginx.com/blog/nginx-1-13-10-grpc/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Reference</a></p>","autoDesc":true}');export{c as comp,r as data};
